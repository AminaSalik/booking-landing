class UploadProcess{constructor(){this.renderHistoryItems(),this.initEventListeners(),this.lastRequestTime=0}initEventListeners(){jQuery(document).on("click",".rm-button-upload-remove-background",e=>this.handleUploadButtonClick(e)),jQuery(document).on("change",".rm-upload-remove-background",e=>this.handleFileChange(e)),jQuery(document).on("click",".rm-upload-try__item",e=>this.handleTryItemClick(e)),this.initDragAndDrop(),this.initPasteEvent(),jQuery(document).on("click",".remove-background-item__view",e=>this.handleItemTabClick(e)),jQuery(document).on("click",".close",e=>this.handleElementRemoveClick(e))}renderHistoryItems(){this.getItemsFromStorage(!0)?.forEach(e=>{this.renderItemElement(e)})}handleUploadButtonClick(e){jQuery(e.currentTarget).parents(".rm-upload-inner").find(".rm-upload-remove-background").trigger("click")}handleFileChange(e){var r=e.currentTarget.files;0<r.length&&(r=r[0],jQuery(e.currentTarget).val(""),this.removeBackground(r))}handleTryItemClick(e){e=jQuery(e.currentTarget).attr("src").replace("_thumb","");e&&this.removeBackground(e)}initDragAndDrop(){let r=jQuery("body"),a=null,i=0;["dragenter","dragover","dragleave","drop"].forEach(e=>{r.on(e,function(e){e.preventDefault(),e.stopPropagation()})}),["dragenter","dragover"].forEach(e=>{r.on(e,()=>{var e;i++,a||((a=document.createElement("div")).id="overlay",a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.background="rgba(0, 0, 0, 0.8)",a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center",a.style.zIndex="9999",(e=document.createElement("div")).style.fontWeight="500",e.className="overlay-content",e.style.textAlign="center",e.style.fontSize="48px",e.style.color="#fff",e.innerText="Drop your file anywhere",a.appendChild(e),document.body.appendChild(a)),a.style.display="flex"})}),r.on("dragover",e=>{e.originalEvent.dataTransfer.dropEffect="copy"}),["dragleave","drop"].forEach(e=>{r.on(e,e=>{0!==--i&&e.relatedTarget&&document.body.contains(e.relatedTarget)||a&&(a.style.display="none")})}),r.on("drop",r=>{var t=r.originalEvent.dataTransfer.files;if(i=0,a&&(a.style.display="none"),0<t.length){let e=t[0];-1!==e.type.indexOf("image")?((t=new FileReader).onload=()=>{this.removeBackground(e)},t.readAsDataURL(e)):RmAlert.Error({title:LocalizedMessages.getMessage("error-title"),message:LocalizedMessages.getMessage("fileTypeErrorMessage")})}else{let e=r.originalEvent.dataTransfer.getData("text");(e=e.replace("_thumb",""))?this.removeBackground(e):RmAlert.Error({title:LocalizedMessages.getMessage("error-title"),message:LocalizedMessages.getMessage("fileTypeErrorMessage")})}})}initPasteEvent(){jQuery("body").on("paste",e=>{var t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let r=0;r<t.length;r++)if(-1!==t[r].type.indexOf("image")){let e=t[r].getAsFile();var a=new FileReader;a.onload=()=>{this.removeBackground(e)},a.readAsDataURL(e)}})}handleItemTabClick(e){var r=jQuery(e.currentTarget).attr("data-tab");jQuery(e.currentTarget).parents(".remove-background-item").hasClass("loading")||(e=jQuery(e.currentTarget).parents(".remove-background-item"),"remove-background-item__preview-result"===r?this.activatePreview(e):"remove-background-item__preview-original"===r&&this.activateOriginal(e))}activateOriginal(e){jQuery(e).find(".remove-background-item__view[data-tab=remove-background-item__preview-result]").removeClass("active"),jQuery(e).find(".remove-background-item__view[data-tab=remove-background-item__preview-original]").addClass("active"),jQuery(e).find(".remove-background-item__preview-tab").removeClass("active"),jQuery(e).find(".remove-background-item__preview-original").addClass("active")}activatePreview(e){jQuery(e).find(".remove-background-item__view[data-tab=remove-background-item__preview-original]").removeClass("active"),jQuery(e).find(".remove-background-item__view[data-tab=remove-background-item__preview-result]").addClass("active"),jQuery(e).find(".remove-background-item__preview-tab").removeClass("active"),jQuery(e).find(".remove-background-item__preview-result").addClass("active")}handleElementRemoveClick(e){let r=jQuery(e.currentTarget).parents(".remove-background-item");RmAlert.Confirm({title:LocalizedMessages.getMessage("confirmRemoveTitle"),message:LocalizedMessages.getMessage("confirmRemoveMessage"),confirmText:LocalizedMessages.getMessage("confirmText"),onConfirm:function(){this.removeItemFromStorage(jQuery(r).find(".original").attr("src")),jQuery(r).remove()}.bind(this)})}renderItemElement(e,r=null){var t=document.createElement("div"),r=null!=r?r:jQuery(".template-upload-item").clone().removeClass("template-upload-item").removeClass("d-none").prop("outerHTML"),r=(t.innerHTML=r,t.firstElementChild);jQuery(r).find(".original").attr("src",e.original),jQuery(r).find(".preview-demo").attr("src",e.preview_demo),jQuery(r).find(".rm-download-preview").attr("href",e.low_resolution),jQuery(r).find(".rmr-image-high").attr("data-res",e.high_resolution),jQuery(r).find(".rmr-image-high").attr("data-img",e.original),jQuery(r).find(".rmr-image-low").attr("data-res",e.low_resolution),jQuery(r).find(".rmr-image-low").attr("data-img",e.original),jQuery(r).find(".rme-image-low").attr("data-res",e.low_resolution),jQuery(r).find(".rme-image-high").attr("data-res",e.high_resolution),jQuery(r).find(".rm-download-high").attr("href",e.high_resolution||"/pricing/"),jQuery(r).find(".rm-high-dimension").text(e.original_width+" x "+e.original_height),jQuery(r).find(".rm-preview-dimension").text(e.preview_width+" x "+e.preview_height),jQuery("#container-result").prepend(r),this.activatePreview(r),jQuery(r).removeClass("loading").find(".error-upload").remove()}renderLoadingElement(e,r=null){var t,a=document.createElement("div"),r=null!=r?r:jQuery(".template-upload-item").clone().removeClass("template-upload-item").removeClass("d-none").prop("outerHTML"),r=(a.innerHTML=r,a.firstElementChild);return jQuery(r).find(".original").attr("src",e),jQuery("#container-result").prepend(r),window.innerWidth<=768?jQuery("html, body").animate({scrollTop:jQuery(r).offset().top-70},800):(a=jQuery(r).offset().top,e=jQuery(r).outerHeight(),t=$(window).height(),jQuery("html, body").animate({scrollTop:a-t/2+e/2},800)),r}elementSuccess(e,r){var t=jQuery(e).find(".original").attr("src");jQuery(e).removeClass("loading").find(".preview-demo").attr("src",r.preview_demo),jQuery(e).find(".rm-download-preview").attr("href",r.low_resolution),jQuery(e).find(".rmr-image-high").attr("data-res",r.high_resolution),jQuery(e).find(".rmr-image-high").attr("data-img",t),jQuery(e).find(".rmr-image-low").attr("data-res",r.low_resolution),jQuery(e).find(".rmr-image-low").attr("data-img",t),jQuery(e).find(".rme-image-low").attr("data-res",r.low_resolution),jQuery(e).find(".rme-image-high").attr("data-res",r.high_resolution),jQuery(e).find(".rm-download-high").attr("href",r.high_resolution||"/pricing/"),jQuery(e).find(".rm-high-dimension").text(r.original_width+" x "+r.original_height),jQuery(e).find(".rm-preview-dimension").text(r.preview_width+" x "+r.preview_height),jQuery(e).find(".remove-background-item__view[data-tab=remove-background-item__preview-result]").click(),jQuery(e).find(".error-upload").remove()}elementError(e){jQuery(e).removeClass("loading").addClass("error"),jQuery(e).find(".remove-background-item__content").remove()}async getWebToken(){return new Promise((r,e)=>{jQuery.ajax({type:"GET",data:{action:"ajax_get_webtoken",security:ajax_upload_object.security},url:ajax_upload_object.webtoken_url,timeout:5e3,success:function(e){r(e.data.webtoken)},error:function(){RmAlert.Error({title:LocalizedMessages.getMessage("errorOccurredTitle"),message:LocalizedMessages.getMessage("errorOccurredMessage")}),e("Error getting web token")}})})}async removeBackground(r){if(Date.now()-this.lastRequestTime<2e3)RmAlert.Info({title:LocalizedMessages.getMessage("slowDownTitle"),message:LocalizedMessages.getMessage("slowDownMessage")});else{this.lastRequestTime=Date.now();let e=r,a=new FormData;if(r instanceof Blob){if(12582912<r.size)return void RmAlert.Error({title:LocalizedMessages.getMessage("error-title"),message:LocalizedMessages.getMessage("fileTooLargeMessage")});e=URL.createObjectURL(r),a.append("image_file",r)}else"string"==typeof r&&a.append("image_url",r);if(!window.location.pathname.includes("/upload")){r=window.location.pathname.split("/");let e="";var r=(e=1<r.length&&2===r[1].length?"/"+r[1]:e)+"/upload/",t=jQuery(".template-upload").clone().removeClass("template-upload").removeClass("d-none").prop("outerHTML"),o=jQuery(".template-upload-item").prop("outerHTML");history.pushState(null,"",r),document.title=LocalizedMessages.getMessage("documentTitleUpload"),jQuery("main").replaceWith(t),jQuery("main").append(o)}let i=this.renderLoadingElement(e);try{let r=ajax_upload_object.api_token,t=await this.getWebToken();jQuery.ajax({type:"POST",url:ajax_upload_object.api_url,data:a,processData:!1,contentType:!1,timeout:6e4,beforeSend:function(e){e.setRequestHeader("Web-Token",t),r&&e.setRequestHeader("Rm-Token",r)},success:e=>{this.addItemToStorage(e),this.elementSuccess(i,e)},error:(e,r,t)=>{429==e.status&&RmAlert.Info({title:LocalizedMessages.getMessage("slowDownTitle"),message:LocalizedMessages.getMessage("slowDownMessage")}),this.elementError(i)}})}catch{this.elementError(i)}}}addItemToStorage(e){e.timestamp=(new Date).getTime();var r=this.getItemsFromStorage();r.unshift(e),localStorage.setItem("remove_background_items",JSON.stringify(r))}getItemsFromStorage(e=!1){let r=JSON.parse(localStorage.getItem("remove_background_items"))||[],t=(new Date).getTime();return r=r.filter(e=>t-e.timestamp<=3e5),(r=e&&5<r.length?r.slice(-5):r).reverse()}removeItemFromStorage(r){let e=this.getItemsFromStorage();e=e.filter(e=>e.original!==r),localStorage.setItem("remove_background_items",JSON.stringify(e))}}jQuery(document).ready(function(){new UploadProcess});